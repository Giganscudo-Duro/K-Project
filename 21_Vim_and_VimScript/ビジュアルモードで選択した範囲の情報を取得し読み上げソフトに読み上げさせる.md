# 参考URL
- [ビジュアルモードの選択情報の取得 ]( https://nanasi.jp/articles/code/screen/visual.html )
- [【vim】ビジュアルモードで選択してPythonに渡す ]( https://tanakatarou.tech/598/ )



# ビジュアルモードの選択情報の取得

## 基本：ビジュアル選択の範囲の取得
```
:let pos = getpos(".")

:normal `<
:echo line(".")
:echo col(".")
"# => 選択開始位置を出力

:normal `>
:echo line(".")
:echo col(".")
"# => 選択終了位置を出力

:call setpos('.', pos)
```


## ビジュアルモードで選択したテキストを取得する
```
:let tmp = @@           " 変数 tmp に「@@（直前に実施したマクロの内容）」を格納
:silent normal gvy      " ビジュアルモードで選択した範囲をヤンク（サイレントモードで）
:let selected = @@      " 変数 selected に「@@（直前に実施したマクロの内容）」を格納
:let @@ = tmp           " 「@@（直前に実施したマクロの内容）」に対し、もともとの内容である tmp を格納
:echo selected          " selected の内容をecho
"# => 選択したテキストを出力
```

# 応用
```
let tmp = @@
silent normal gvy
let selected = @@
let @@ = tmp
echo selected
"# => 選択したテキストを出力

```


# 実際に作成したプラグイン
VOICEROID(今回は月読アイと東北イタコ)に読み上げさせるという仕様上、Windows環境上でしか利用できない。

## 参考URL
- [民安★TALK ver.1.35.0 アップデート内容]( https://publish-tool.blogspot.com/ )
- [民安★TALK ダウンロードページ]( https://publish-tool.blogspot.com/2012/09/voiceroid-live-gear2ch-niconama-comment.html )
- [VOICEROID +EX をwindows10にうまくインストールできない]( https://ikorin2.hatenablog.jp/entry/2018/04/15/033938 )
- [VOICEROID（とその他いろいろ）基本調声メモ]( https://www.echikara.net/voiceroid/2019-11-02/502/ )
- [Zundatter - ずんだったー]( http://blackstraycat.nobody.jp/zunko/zundatter.html )
- [[vokiri] VOICEROID＋ 東北きりたん の読み上げをコマンドラインから行えるようにするツールを作りました]( https://shu-b10g.blogspot.com/2017/02/vokiri-voiceroid.html )


- [VOICEROID+ 琴葉 茜・葵 - FAQ - Windows10 にインストール・アクティベートできない - Voiceroid公式]( https://www.ah-soft.com/voiceroid/kotonoha_1/#faq )
- [AHS マイページ（Windows10用インストーラ）]( https://www.ah-soft.com/mypage/ )


## 事前準備
- 「民安★TALK」をインストール
- 「VOICEROID」をインストール

## 利用方法
ビジュアルモードで文字列を反転させた状態で、`Ctrl+k read`を実行。

## 導入方法
以下の記述を、`.vimrc` もしくは`_gvimrc`に追加する。
基本はgvim上で利用するので、後者に追加することを推奨。

```
"【ビジュアルモードで選択した範囲のテキストを読み上げる】
"{{{
" なぜか、vrx.exe に渡される文字列の順序がおかしくなる場合がある。
" vimproc#popen2 での非同期処理の呼び出し順序がおかしくなってる？
function! KanaReadByVoiceloid_Ver2()
    " echo "Call KanaReadByVoiceloid"
    set shell=cmd.exe

    " 民安★TALKのインストールパスを設定（文字列を Voiceroid に中継するアプリ）
    let s:application = '"D:\\ProgramFiles\\tamiyasu_talk\\vrx.exe"'

    " ビジュアルモードでの選択範囲をヤンク
    y
    " ヤンクした内容を格納
    let s:base_string = @@
    " echo s:base_string
    " 改行コードを\nに置き換える
    " let strings2 = substitute(strings1, "
", "\n", "g")
    " echo "strings2 = ". strings2

    " 文字列をシェルコマンドとして使えるようエスケープ処理
    let s:escaped_string = shellescape(s:base_string)
    " echo s:escaped_string

    " 実行アプリのパスと、読み上げさせたい文字列を連結
    call vimproc#popen3(s:application . " " . s:escaped_string)

    set shell=vimrun.exe
endfunction
" " }}}
" " ==== 上記関数の呼び出し
map <C-K>read :call KanaReadByVoiceloid_Ver2()<CR>
```

